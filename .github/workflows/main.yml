name: Build Unity Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-unity-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential expect cppcheck
        
        # æ£€æŸ¥ cppcheck æ˜¯å¦æ”¯æŒ MISRA æ’ä»¶
        echo "Checking cppcheck MISRA support:"
        cppcheck --help | grep -i misra || echo "MISRA addon may need manual setup"
        
    - name: Setup MISRA C Configuration
      run: |
        # åˆ›å»º cppcheck é…ç½®æ–‡ä»¶ï¼ˆç”¨äº MISRA æ£€æŸ¥ï¼‰
        cat > cppcheck.cfg << 'EOF'
        # Cppcheck configuration for MISRA C
        [common]
        language=c
        std=c99
        
        [misra]
        enable=all
        
        [suppressions]
        # æŠ‘åˆ¶ä¸€äº›å¯¹åµŒå…¥å¼ç³»ç»Ÿä¸é€‚ç”¨çš„è§„åˆ™
        missingIncludeSystem
        unmatchedSuppression
        unusedFunction
        EOF
        
        # æ£€æŸ¥é¡¹ç›®ä¸­çš„ C æ–‡ä»¶
        echo "Found C files for analysis:"
        find 7.ELAB_NANO_Unity/elab/ -name "*.c" -not -path "*/3rd/Unity/*" | head -10
    
    - name: MISRA C Static Analysis
      run: |
        echo "ğŸ” Running MISRA C compliance check with cppcheck..."
        
        # é¦–å…ˆå°è¯•åŸºç¡€çš„ cppcheck åˆ†æ
        echo "Running basic cppcheck analysis..."
        cppcheck --enable=all \
          --inconclusive \
          --xml \
          --xml-version=2 \
          --suppress=missingIncludeSystem \
          --suppress=unmatchedSuppression \
          --suppress=unusedFunction \
          --std=c99 \
          --platform=unix32 \
          -I 7.ELAB_NANO_Unity/elab/common/ \
          -I 7.ELAB_NANO_Unity/elab/3rd/ \
          7.ELAB_NANO_Unity/elab/common/ \
          7.ELAB_NANO_Unity/elab/elib/ \
          2> cppcheck-report.xml || true
        
        # å°è¯•è¿è¡Œ MISRA æ£€æŸ¥ï¼ˆå¦‚æœæ”¯æŒï¼‰
        echo "Attempting MISRA C analysis..."
        if cppcheck --addon=misra --help > /dev/null 2>&1; then
          echo "MISRA addon available, running MISRA analysis..."
          cppcheck --addon=misra \
            --enable=all \
            --xml \
            --xml-version=2 \
            --suppress=missingIncludeSystem \
            --suppress=unmatchedSuppression \
            --std=c99 \
            7.ELAB_NANO_Unity/elab/common/ \
            7.ELAB_NANO_Unity/elab/elib/ \
            2> misra-report.xml || true
        else
          echo "MISRA addon not available, using standard cppcheck analysis"
          cp cppcheck-report.xml misra-report.xml
        fi
        
        # åˆ†ææŠ¥å‘Š
        echo "ğŸ“Š Static Analysis Results:"
        echo "=========================="
        
        if [ -s cppcheck-report.xml ]; then
          total_issues=$(grep -o "<error " cppcheck-report.xml | wc -l)
          error_count=$(grep -o 'severity="error"' cppcheck-report.xml | wc -l)
          warning_count=$(grep -o 'severity="warning"' cppcheck-report.xml | wc -l)
          
          echo "Total issues found: $total_issues"
          echo "Errors: $error_count"
          echo "Warnings: $warning_count"
          
          if [ $error_count -gt 0 ]; then
            echo "âŒ Code quality check failed due to errors"
            echo "Review the detailed report for issues that must be fixed"
          else
            echo "âœ… No critical issues found"
          fi
        else
          echo "âœ… No issues detected"
        fi
    
    - name: Configure CMake for unity_test
      run: |
        cd 7.ELAB_NANO_Unity/example/unity_test
        cmake -B build -DCMAKE_BUILD_TYPE=Debug
    
    - name: Build unity_test
      run: |
        cd 7.ELAB_NANO_Unity/example/unity_test
        cmake --build build
    
    - name: Run unity_test
      run: |
        cd 7.ELAB_NANO_Unity/example/unity_test/build
        # åˆ›å»º expect è„šæœ¬æ¥å¤„ç†äº¤äº’å¼ç¨‹åºå¹¶æ£€æµ‹æµ‹è¯•ç»“æœ
        cat > run_unity_test.exp << 'EOF'
        #!/usr/bin/expect -f
        # åŒ¹é…Unityæµ‹è¯•ç»“æœè¶…æ—¶æ—¶é—´
        set timeout 30
        
        # å¯åŠ¨ç¨‹åº
        spawn sudo ./unity_example
        
        # ç­‰å¾…ç¨‹åºå®Œå…¨å¯åŠ¨å¹¶ç¨³å®š
        sleep 3
        
        # å‘é€ unity å‘½ä»¤
        send "unity\r"
        
        # ç­‰å¾…æµ‹è¯•ç»“æœ
        expect {
          # åŒ¹é…æˆåŠŸçš„æµ‹è¯•ç»“æœ
          -re {([0-9]+) Tests ([0-9]+) Failures ([0-9]+) Ignored} {
            set tests $expect_out(1,string)
            set failures $expect_out(2,string)
            set ignored $expect_out(3,string)
            
            puts "\n=== Unity Test Results ==="
            puts "Tests: $tests"
            puts "Failures: $failures" 
            puts "Ignored: $ignored"
            
            # ç»§ç»­ç­‰å¾…æœ€ç»ˆçŠ¶æ€ (OK/FAIL)
            expect {
              "OK" {
                puts "Status: PASSED (All tests successful)"
                puts "=========================\n"
                send "\x03"
                # ç»™ç¨‹åºä¸€ç‚¹æ—¶é—´å“åº” Ctrl+C
                sleep 2
                exit 0
              }
              "FAIL" {
                puts "Status: FAILED (Some tests failed)"
                puts "=========================\n"
                send "\x03"
                # ç»™ç¨‹åºä¸€ç‚¹æ—¶é—´å“åº” Ctrl+C
                sleep 2
                exit 1
              }
              timeout {
                puts "Status: TIMEOUT (No final status received)"
                puts "Trying to terminate program gracefully..."
                puts "=========================\n"
                send "\x03"
                # ç»™ç¨‹åºä¸€ç‚¹æ—¶é—´å“åº” Ctrl+C
                sleep 2
                exit 1
              }
            }
          }
          
          # å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°æµ‹è¯•ç»“æœæ ¼å¼
          timeout {
            puts "\n=== Unity Test Results ==="
            puts "Status: TIMEOUT - No test results detected"
            puts "Trying to terminate program gracefully..."
            puts "=========================\n"
            send "\x03"
            # ç»™ç¨‹åºä¸€ç‚¹æ—¶é—´å“åº” Ctrl+C
            sleep 2
            expect eof
            exit 1
          }
          
          eof {
            puts "\n=== Unity Test Results ==="
            puts "Status: COMPLETED - Check output above for results"
            puts "=========================\n"
            exit 0
          }
        }
        EOF
        
        # è¿è¡Œ expect è„šæœ¬å¹¶æ•è·é€€å‡ºç 
        chmod +x run_unity_test.exp
        if ./run_unity_test.exp; then
          echo "âœ… Unity tests PASSED: All tests completed successfully!"
        else
          echo "âŒ Unity tests FAILED: Check the detailed results above"
          echo "   Possible reasons:"
          echo "   - Some unit tests failed"
          echo "   - Test execution timed out"
          echo "   - Program crashed or hung"
          exit 1
        fi
        
        # æ¸…ç†
        rm -f run_unity_test.exp
        #continue-on-error: true  #æµ‹è¯•æµåœ¨å‡ºç°é”™è¯¯æ—¶ä¹Ÿä¼šç»§ç»­ (ä¸æŠ¥é”™)
    
    - name: Upload Static Analysis Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: static-analysis-report
        path: |
          cppcheck-report.xml
          misra-report.xml
          cppcheck.cfg
        retention-days: 14
        
    - name: Code Quality Summary
      if: always()
      run: |
        echo "ğŸ“‹ Code Quality Analysis Summary:"
        echo "================================"
        
        if [ -f cppcheck-report.xml ] && [ -s cppcheck-report.xml ]; then
          total_issues=$(grep -o "<error " cppcheck-report.xml | wc -l)
          critical_errors=$(grep -o 'severity="error"' cppcheck-report.xml | wc -l)
          
          echo "ğŸ” Total issues found: $total_issues"
          echo "ğŸš¨ Critical errors: $critical_errors"
          
          if [ $critical_errors -gt 0 ]; then
            echo "âŒ Code quality check: FAILED"
            echo "   Critical issues must be fixed before release"
          elif [ $total_issues -gt 0 ]; then
            echo "âš ï¸  Code quality check: WARNINGS"
            echo "   Some issues found, review recommended"
          else
            echo "âœ… Code quality check: PASSED"
          fi
        else
          echo "âœ… Code quality check: PASSED (no issues)"
        fi
        
        echo ""
        echo "ğŸ“ Detailed analysis report uploaded as artifact"
        echo "ï¿½ Use cppcheck locally for faster development feedback"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: unity-test-build
        path: |
          7.ELAB_NANO_Unity/example/unity_test/build/unity_example
          7.ELAB_NANO_Unity/example/unity_test/build/compile_commands.json
        retention-days: 7