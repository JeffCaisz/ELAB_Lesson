name: Build Unity Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-unity-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential expect cppcheck python3-pip
        
        # å®‰è£… MISRA C è§„åˆ™æ–‡ä»¶ï¼ˆå¦‚æžœå¯ç”¨ï¼‰
        pip3 install misra-c
        
    - name: Setup MISRA C Configuration
      run: |
        # åˆ›å»º MISRA C é…ç½®æ–‡ä»¶
        cat > misra-c.txt << 'EOF'
        # MISRA C 2012 è§„åˆ™é…ç½®
        # å¿…é¡»éµå®ˆçš„è§„åˆ™ (Required)
        rule-1.3
        rule-2.1
        rule-2.2
        rule-2.3
        rule-2.4
        rule-2.5
        rule-2.6
        rule-2.7
        rule-3.1
        rule-3.2
        rule-4.1
        rule-4.2
        rule-5.1
        rule-5.2
        rule-5.3
        rule-5.4
        rule-5.5
        rule-5.6
        rule-5.7
        rule-5.8
        rule-5.9
        rule-6.1
        rule-6.2
        rule-7.1
        rule-7.2
        rule-7.3
        rule-7.4
        rule-8.1
        rule-8.2
        rule-8.3
        rule-8.4
        rule-8.5
        rule-8.6
        rule-8.7
        rule-8.8
        rule-8.9
        rule-8.10
        rule-8.11
        rule-8.12
        rule-8.13
        rule-8.14
        rule-9.1
        rule-9.2
        rule-9.3
        rule-9.4
        rule-9.5
        rule-10.1
        rule-10.2
        rule-10.3
        rule-10.4
        rule-10.5
        rule-10.6
        rule-10.7
        rule-10.8
        rule-11.1
        rule-11.2
        rule-11.3
        rule-11.4
        rule-11.5
        rule-11.6
        rule-11.7
        rule-11.8
        rule-11.9
        rule-12.1
        rule-12.2
        rule-12.3
        rule-12.4
        rule-12.5
        rule-13.1
        rule-13.2
        rule-13.3
        rule-13.4
        rule-13.5
        rule-13.6
        rule-14.1
        rule-14.2
        rule-14.3
        rule-14.4
        rule-15.1
        rule-15.2
        rule-15.3
        rule-15.4
        rule-15.5
        rule-15.6
        rule-15.7
        rule-16.1
        rule-16.2
        rule-16.3
        rule-16.4
        rule-16.5
        rule-16.6
        rule-16.7
        rule-17.1
        rule-17.2
        rule-17.3
        rule-17.4
        rule-17.5
        rule-17.6
        rule-17.7
        rule-17.8
        rule-18.1
        rule-18.2
        rule-18.3
        rule-18.4
        rule-18.5
        rule-18.6
        rule-18.7
        rule-18.8
        rule-19.1
        rule-19.2
        rule-20.1
        rule-20.2
        rule-20.3
        rule-20.4
        rule-20.5
        rule-20.6
        rule-20.7
        rule-20.8
        rule-20.9
        rule-20.10
        rule-20.11
        rule-20.12
        rule-21.1
        rule-21.2
        rule-21.3
        rule-21.4
        rule-21.5
        rule-21.6
        rule-21.7
        rule-21.8
        rule-21.9
        rule-21.10
        rule-21.11
        rule-21.12
        rule-22.1
        rule-22.2
        rule-22.3
        rule-22.4
        rule-22.5
        rule-22.6
        EOF
        
        # åˆ›å»º cppcheck é…ç½®æ–‡ä»¶
        cat > cppcheck.cfg << 'EOF'
        # Cppcheck configuration for MISRA C
        [common]
        language=c
        std=c99
        
        [misra]
        enable=all
        
        [suppressions]
        # æŠ‘åˆ¶ä¸€äº›å¯¹åµŒå…¥å¼ç³»ç»Ÿä¸é€‚ç”¨çš„è§„åˆ™
        missingIncludeSystem
        unmatchedSuppression
        EOF
    
    - name: MISRA C Static Analysis
      run: |
        echo "ðŸ” Running MISRA C compliance check with cppcheck..."
        
        # è¿è¡Œå¸¦ MISRA C è§„åˆ™çš„ cppcheck
        cppcheck --addon=misra \
          --enable=all \
          --inconclusive \
          --xml \
          --xml-version=2 \
          --suppress=missingIncludeSystem \
          --suppress=unmatchedSuppression \
          --suppress=unusedFunction \
          --std=c99 \
          --platform=unix32 \
          -I 7.ELAB_NANO_Unity/elab/common/ \
          -I 7.ELAB_NANO_Unity/elab/3rd/ \
          7.ELAB_NANO_Unity/elab/ \
          2> misra-report.xml || true
        
        # åˆ†æž MISRA æŠ¥å‘Š
        echo "ðŸ“Š MISRA C Analysis Results:"
        echo "============================"
        
        if [ -s misra-report.xml ]; then
          # ç»Ÿè®¡ä¸åŒç±»åž‹çš„ MISRA è¿è§„
          total_misra=$(grep -o "misra-c2012-" misra-report.xml | wc -l)
          error_count=$(grep -o 'severity="error"' misra-report.xml | wc -l)
          warning_count=$(grep -o 'severity="warning"' misra-report.xml | wc -l)
          style_count=$(grep -o 'severity="style"' misra-report.xml | wc -l)
          
          echo "Total MISRA violations: $total_misra"
          echo "Errors: $error_count"
          echo "Warnings: $warning_count"  
          echo "Style issues: $style_count"
          
          # æ˜¾ç¤ºæœ€å¸¸è§çš„è¿è§„ç±»åž‹
          echo ""
          echo "Top MISRA violations:"
          grep -o "misra-c2012-[0-9]\+\.[0-9]\+" misra-report.xml | sort | uniq -c | sort -nr | head -10
          
          # å¦‚æžœæœ‰ä¸¥é‡é”™è¯¯ï¼Œæ ‡è®°ä¸ºå¤±è´¥
          if [ $error_count -gt 0 ]; then
            echo "âŒ MISRA C compliance check failed due to errors"
            echo "Review the detailed report for violations that must be fixed"
          else
            echo "âœ… No critical MISRA C violations found"
          fi
        else
          echo "âœ… No MISRA C violations detected"
        fi
    
    - name: Configure CMake for unity_test
      run: |
        cd 7.ELAB_NANO_Unity/example/unity_test
        cmake -B build -DCMAKE_BUILD_TYPE=Debug
    
    - name: Build unity_test
      run: |
        cd 7.ELAB_NANO_Unity/example/unity_test
        cmake --build build
    
    - name: Run unity_test
      run: |
        cd 7.ELAB_NANO_Unity/example/unity_test/build
        # åˆ›å»º expect è„šæœ¬æ¥å¤„ç†äº¤äº’å¼ç¨‹åºå¹¶æ£€æµ‹æµ‹è¯•ç»“æžœ
        cat > run_unity_test.exp << 'EOF'
        #!/usr/bin/expect -f
        # åŒ¹é…Unityæµ‹è¯•ç»“æžœè¶…æ—¶æ—¶é—´
        set timeout 30
        
        # å¯åŠ¨ç¨‹åº
        spawn sudo ./unity_example
        
        # ç­‰å¾…ç¨‹åºå®Œå…¨å¯åŠ¨å¹¶ç¨³å®š
        sleep 3
        
        # å‘é€ unity å‘½ä»¤
        send "unity\r"
        
        # ç­‰å¾…æµ‹è¯•ç»“æžœ
        expect {
          # åŒ¹é…æˆåŠŸçš„æµ‹è¯•ç»“æžœ
          -re {([0-9]+) Tests ([0-9]+) Failures ([0-9]+) Ignored} {
            set tests $expect_out(1,string)
            set failures $expect_out(2,string)
            set ignored $expect_out(3,string)
            
            puts "\n=== Unity Test Results ==="
            puts "Tests: $tests"
            puts "Failures: $failures" 
            puts "Ignored: $ignored"
            
            # ç»§ç»­ç­‰å¾…æœ€ç»ˆçŠ¶æ€ (OK/FAIL)
            expect {
              "OK" {
                puts "Status: PASSED (All tests successful)"
                puts "=========================\n"
                send "\x03"
                # ç»™ç¨‹åºä¸€ç‚¹æ—¶é—´å“åº” Ctrl+C
                sleep 2
                exit 0
              }
              "FAIL" {
                puts "Status: FAILED (Some tests failed)"
                puts "=========================\n"
                send "\x03"
                # ç»™ç¨‹åºä¸€ç‚¹æ—¶é—´å“åº” Ctrl+C
                sleep 2
                exit 1
              }
              timeout {
                puts "Status: TIMEOUT (No final status received)"
                puts "Trying to terminate program gracefully..."
                puts "=========================\n"
                send "\x03"
                # ç»™ç¨‹åºä¸€ç‚¹æ—¶é—´å“åº” Ctrl+C
                sleep 2
                exit 1
              }
            }
          }
          
          # å¦‚æžœæ²¡æœ‰åŒ¹é…åˆ°æµ‹è¯•ç»“æžœæ ¼å¼
          timeout {
            puts "\n=== Unity Test Results ==="
            puts "Status: TIMEOUT - No test results detected"
            puts "Trying to terminate program gracefully..."
            puts "=========================\n"
            send "\x03"
            # ç»™ç¨‹åºä¸€ç‚¹æ—¶é—´å“åº” Ctrl+C
            sleep 2
            expect eof
            exit 1
          }
          
          eof {
            puts "\n=== Unity Test Results ==="
            puts "Status: COMPLETED - Check output above for results"
            puts "=========================\n"
            exit 0
          }
        }
        EOF
        
        # è¿è¡Œ expect è„šæœ¬å¹¶æ•èŽ·é€€å‡ºç 
        chmod +x run_unity_test.exp
        if ./run_unity_test.exp; then
          echo "âœ… Unity tests PASSED: All tests completed successfully!"
        else
          echo "âŒ Unity tests FAILED: Check the detailed results above"
          echo "   Possible reasons:"
          echo "   - Some unit tests failed"
          echo "   - Test execution timed out"
          echo "   - Program crashed or hung"
          exit 1
        fi
        
        # æ¸…ç†
        rm -f run_unity_test.exp
        #continue-on-error: true  #æµ‹è¯•æµåœ¨å‡ºçŽ°é”™è¯¯æ—¶ä¹Ÿä¼šç»§ç»­ (ä¸æŠ¥é”™)
    
    - name: Upload MISRA C Analysis Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: misra-c-analysis-report
        path: |
          misra-report.xml
          misra-c.txt
          cppcheck.cfg
        retention-days: 14
        
    - name: MISRA C Compliance Summary
      if: always()
      run: |
        echo "ðŸ“‹ MISRA C 2012 Compliance Summary:"
        echo "==================================="
        
        if [ -f misra-report.xml ] && [ -s misra-report.xml ]; then
          total_violations=$(grep -o "misra-c2012-" misra-report.xml | wc -l)
          critical_errors=$(grep -o 'severity="error"' misra-report.xml | wc -l)
          
          echo "ðŸ” Total MISRA violations: $total_violations"
          echo "ðŸš¨ Critical errors: $critical_errors"
          
          if [ $critical_errors -gt 0 ]; then
            echo "âŒ MISRA C compliance: FAILED"
            echo "   Critical violations must be fixed before release"
          elif [ $total_violations -gt 0 ]; then
            echo "âš ï¸  MISRA C compliance: WARNINGS"
            echo "   Some violations found, review recommended"
          else
            echo "âœ… MISRA C compliance: PASSED"
          fi
        else
          echo "âœ… MISRA C compliance: PASSED (no violations)"
        fi
        
        echo ""
        echo "ðŸ“ Detailed MISRA C report uploaded as artifact"
        echo "ðŸ“– Refer to MISRA C:2012 guidelines for violation explanations"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: unity-test-build
        path: |
          7.ELAB_NANO_Unity/example/unity_test/build/unity_example
          7.ELAB_NANO_Unity/example/unity_test/build/compile_commands.json
        retention-days: 7